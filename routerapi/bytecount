#!/usr/bin/python

import json, re, auth
from subprocess import check_output
from datetime import datetime

def get_byte_counts(network_name):
  parser_pattern = re.compile('SRC packets: \d+ bytes: (\d+) DST packets: \d+ bytes: (\d+)')
  network_data = parser_pattern.findall(check_output(["/usr/sbin/iptaccount", "-l", network_name]))
  if network_data == []:
    return [0, 0]
  else:
    return [float(network_data[0][1]), float(network_data[0][0])]

[privateWifiToLan, x] = get_byte_counts("privatewifitolan")
[lanToPrivateWifi, x] = get_byte_counts("lantoprivatewifi")

[internetUploadUsage, internetDownloadUsage] = get_byte_counts("total-wan")
[openWirelessUploadUsage, openWirelessDownloadUsage] = get_byte_counts("open-wifi")

[lanNetworkUploadUsage, lanNetworkDownloadUsage] = get_byte_counts("wired-lan")
lanNetworkUploadUsage -= lanToPrivateWifi
lanNetworkDownloadUsage -= privateWifiToLan

[privateWifiUploadUsage, privateWifiDownloadUsage] = get_byte_counts("private-wifi")
privateWifiUploadUsage -= privateWifiToLan
privateWifiDownloadUsage -= lanToPrivateWifi

result = {
  "internet": {
    "uploadUsage" : internetUploadUsage,
    "downloadUsage" : internetDownloadUsage
  },
  "lanNetwork": {
    "uploadUsage" : lanNetworkUploadUsage,
    "downloadUsage" : lanNetworkDownloadUsage
  },
  "privateWifi": {
    "uploadUsage" : privateWifiUploadUsage,
    "downloadUsage" : privateWifiDownloadUsage
  },
  "openWireless": {
    "uploadUsage" : openWirelessUploadUsage,
    "downloadUsage" : openWirelessDownloadUsage
  },
  "dateTime" : datetime.now().isoformat()
}

print "Content-Type:application/json\r\n"
print json.JSONEncoder().encode(result)
